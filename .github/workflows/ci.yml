name: Artifex-AI Apex CI/CD Pipeline

on: 
  push:
    branches:
      - main
      - dev
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "**/docs/**"
  pull_request:
    branches:
      - main
      - dev

env:
  NODE_VERSION: '20' # Node LTS Standard 20.x

jobs:
  # ----------------------------------------
  # STAGE 1: CORE INTEGRITY CHECK (LINT/FORMAT)
  # ----------------------------------------
  code_quality:
    name: "‚õîÔ∏è Code Quality Assurance (Lint & Format)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Root Dependencies
        # Assumes root dependencies handle shared tools like Biome/ESLint
        run: npm ci

      - name: Enforce Code Style and Linting
        # Assumes 'npm run lint' and 'npm run format:check' scripts exist at root
        run: |
          npm run lint
          npm run format:check

  # ----------------------------------------
  # STAGE 2: SERVER (EXPRESS.JS) PIPELINE
  # ----------------------------------------
  server_build_test:
    name: "‚öôÔ∏è Server (Express.js) Build & Test"
    runs-on: ubuntu-latest
    needs: [code_quality]
    defaults:
      run:
        working-directory: server/ 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install Server Dependencies
        run: npm ci

      - name: Run Server Unit Tests & Coverage
        # Assumes 'npm test' runs tests and generates coverage report
        run: npm test -- --coverage
        env:
          NODE_ENV: test
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # Required for AI modules

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: server/coverage/
          files: ./coverage/clover.xml # Adjust path based on test runner output
          fail_ci_if_error: true

      - name: Build Server Artifact
        # Transpilation step (e.g., if using TypeScript)
        run: npm run build

  # ----------------------------------------
  # STAGE 3: CLIENT (REACT NATIVE) PIPELINE
  # ----------------------------------------
  client_test_build:
    name: "üì± Client (React Native) Test & Bundle Check"
    runs-on: ubuntu-latest
    needs: [code_quality]
    defaults:
      run:
        working-directory: client/
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Client Dependencies
        run: npm ci

      - name: Run Client Unit Tests
        # Includes functional component tests
        run: npm test

      - name: Check Client Bundle Readiness (Web/Expo Build)
        # Ensures React Native code is correctly configured for bundling/transpilation
        run: npm run build:web # Example script for basic bundling validation